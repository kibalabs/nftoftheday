import os
import sys

sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))

import asyncio
import logging
from core.requester import Requester
from core.web3.eth_client import RestEthClient
import datetime


from notd.block_processor import BlockProcessor
from notd.model import  RetrievedTokenTransfer



async def main():
    requester = Requester()
    ethClient = RestEthClient(url=f'https://mainnet.infura.io/v3/{os.environ["INFURA_PROJECT_ID"]}', requester=requester)
    blockProcessor = BlockProcessor(ethClient=ethClient)

    result = await blockProcessor.get_transfers_in_block(13281280)
    expected = [
        RetrievedTokenTransfer(transactionHash='0x3a59e929b3dcdfd412ee35cb0d88a9b13693e38869d976bef92569e249b89dee', registryAddress='0x33825285eB66c11237Cc68CC182c1e9BF01bA00B', fromAddress='0x857784eA852149c21aD6025E94b715E753Cc2124', toAddress='0xF8ca0a9aAdfBD7470B77DB6D2498CDE243ba8420', operatorAddress='0xF8ca0a9aAdfBD7470B77DB6D2498CDE243ba8420', tokenId='4973', amount=1, value=164900000000000000, gasLimit=236924, gasPrice=58300000000, gasUsed=172508, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0xf1f0758d54474efb810e470592349703adc758c5037e56ae1bd6a789e9a079ef', registryAddress='0x2216d47494E516d8206B70FCa8585820eD3C4946', fromAddress='0xffF8f66e26ac1A75F2b5Da49c247f3Ec0D0EA5ba', toAddress='0x0000000000000000000000000000000000080085', operatorAddress='0xffF8f66e26ac1A75F2b5Da49c247f3Ec0D0EA5ba', tokenId='14364', amount=1, value=0, gasLimit=449751, gasPrice=48786337690, gasUsed=271034, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0xf1f0758d54474efb810e470592349703adc758c5037e56ae1bd6a789e9a079ef', registryAddress='0x2216d47494E516d8206B70FCa8585820eD3C4946', fromAddress='0xffF8f66e26ac1A75F2b5Da49c247f3Ec0D0EA5ba', toAddress='0x0000000000000000000000000000000000080085', operatorAddress='0xffF8f66e26ac1A75F2b5Da49c247f3Ec0D0EA5ba', tokenId='10626', amount=1, value=0, gasLimit=449751, gasPrice=48786337690, gasUsed=271034, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0xf1f0758d54474efb810e470592349703adc758c5037e56ae1bd6a789e9a079ef', registryAddress='0x2216d47494E516d8206B70FCa8585820eD3C4946', fromAddress='0xffF8f66e26ac1A75F2b5Da49c247f3Ec0D0EA5ba', toAddress='0x0000000000000000000000000000000000080085', operatorAddress='0xffF8f66e26ac1A75F2b5Da49c247f3Ec0D0EA5ba', tokenId='10627', amount=1, value=0, gasLimit=449751, gasPrice=48786337690, gasUsed=271034, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0xfb9e13d47dc451e8c080245488771a5589bc1e461a2911c8dcfd713267df5dbc', registryAddress='0xF8C08433DD41eAeE2e424C9E91467aB27772d9ec', fromAddress='0x44F360a7771888B5Ad92677D795aA10EA88203CA', toAddress='0x62F56981d431e68B5CAb37ae3A242a72824D3ac7', operatorAddress='0x44F360a7771888B5Ad92677D795aA10EA88203CA', tokenId='97', amount=1, value=0, gasLimit=60316, gasPrice=46000000000, gasUsed=41597, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0x786dedd3df009705c246629c864e839b78b897319d346540f10bb84dabbacbb4', registryAddress='0xC00d444eeD049ad0d858a4A8D6Cac5417054405D', fromAddress='0x089660619d26b6CA62EaCD74e2DdD6089024fcCc', toAddress='0xa1F39F1a900A44DDFC702f9071808a07B841f377', operatorAddress='0xa1F39F1a900A44DDFC702f9071808a07B841f377', tokenId='1681', amount=1, value=9000000000000000, gasLimit=331269, gasPrice=45871801906, gasUsed=235481, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0x35bf97445892e633811b0251cba7056f0f6d00d127b38e3414f9b219839a0d5a', registryAddress='0x06012c8cf97BEaD5deAe237070F9587f8E7A266d', fromAddress='0xb1690C08E213a35Ed9bAb7B318DE14420FB57d8C', toAddress='0x52b2A1cc5BF5701408A0aAB889fB5ab2Cf65275b', operatorAddress='0x52b2A1cc5BF5701408A0aAB889fB5ab2Cf65275b', tokenId='938228', amount=1, value=19857666997354498, gasLimit=168463, gasPrice=45721801906, gasUsed=96944, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0x5f240c53fafdf13e16ea02c3e94b8daec4c0d36272ea5cc639a211e344afd6c8', registryAddress='0xa64C5EC80784675bf289A4722a2eca180212f9dB', fromAddress='0x57B386815E928BBF43aB16cfD7f268E7f861c0AA', toAddress='0xf3E09Fa1754c77aECe0808197b2cAAE896b1C3eD', operatorAddress='0xf3E09Fa1754c77aECe0808197b2cAAE896b1C3eD', tokenId='1718', amount=1, value=50000000000000000, gasLimit=312990, gasPrice=45721801906, gasUsed=226220, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0xd913164a0166140027e68fad832d1942cde756709c778697844f9ab10eb35e4c', registryAddress='0xC36442b4a4522E871399CD717aBDD847Ab11FE88', fromAddress='0x0000000000000000000000000000000000000000', toAddress='0x6B33a55786b2412c5283bfFc0383Ca35D702B388', operatorAddress='0x6B33a55786b2412c5283bfFc0383Ca35D702B388', tokenId='130999', amount=1, value=479676176628488569, gasLimit=626642, gasPrice=45681801906, gasUsed=493984, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0x355f53288cb9d9b91012470d681bd3453c5253d54f2becb17d20e4347432ce09', registryAddress='0x495f947276749Ce646f68AC8c248420045cb7b5e', fromAddress='0x473fD7FB5826D0CB76903c8bFb5E8E0f1a717626', toAddress='0xCCa178a04D83Af193330C7927fb9a42212Fb1C25', operatorAddress='0x8945F51c47e1B2406f4D96c3E795010A59B954eb', tokenId='32227014266187574693694258784543567127334353629417101029986949134666818388768', amount=1, value=500000000000000000, gasLimit=271893, gasPrice=46221801906, gasUsed=201407, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc1155single'), 
        RetrievedTokenTransfer(transactionHash='0x3234d993232494cb0ac88ed94580e7c23b2291629c5321acb3793d51d732dc79', registryAddress='0xF1F3ca6268f330fDa08418db12171c3173eE39C9', fromAddress='0x0000000000000000000000000000000000000000', toAddress='0x5B1A00402c6aaBC799aa30d009Fb26ec7980BA0a', operatorAddress='0x5B1A00402c6aaBC799aa30d009Fb26ec7980BA0a', tokenId='8', amount=2, value=0, gasLimit=62020, gasPrice=46000000000, gasUsed=56382, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc1155single'), 
        RetrievedTokenTransfer(transactionHash='0xc23496871eaf21f0bcbb7a10fa449e1d0f307b1f4493c12d6a4009d21a73d4dd', registryAddress='0x9f75A77966ADE660782f73f822c836C32BE6784a', fromAddress='0xA09e8346B1F58F49622C81B7B1fe26441f0a8f28', toAddress='0x2953399124F0cBB46d2CbACD8A89cF0599974963', operatorAddress='0xA09e8346B1F58F49622C81B7B1fe26441f0a8f28', tokenId='41', amount=1, value=0, gasLimit=57213, gasPrice=45721801906, gasUsed=57213, blockNumber=13281280, blockHash='0x79da1d97baead833e2b4e597a24d08a0e5efddd2c7f0983f776836a8ffb03d4c', blockDate=datetime.datetime(2021, 9, 23, 10, 50, 9), tokenType='erc1155single')
    ]
    assert (result == expected)

    result = await blockProcessor.get_transfers_in_block(12839305)
    expected = [
        RetrievedTokenTransfer(transactionHash='0xfc8ffb7652d77c1b880a80134bdce050c9bf712610fa9dc0d3d3fa83c10d3a1b', registryAddress='0xFBB6684EbD6093989740e8ef3e7D57cf3813E5a4', fromAddress='0x0000000000000000000000000000000000000000', toAddress='0x18090cDA49B21dEAffC21b4F886aed3eB787d032', operatorAddress='0x18090cDA49B21dEAffC21b4F886aed3eB787d032', tokenId='9991', amount=1, value=0, gasLimit=184165, gasPrice=40000000000, gasUsed=184165, blockNumber=12839305, blockHash='0x7e36a9f127f3413595ef0f1c4165e4547d20ab566b66fc51a3cbe9eb048f3154', blockDate=datetime.datetime(2021, 7, 16, 18, 41, 41), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0x3093bb2c8cbf1d229594d2cb8b172558fb6730721d9ef561b6400543a59f3734', registryAddress='0x049aba7510f45BA5b64ea9E658E342F904DB358D', fromAddress='0x0000000000000000000000000000000000000000', toAddress='0x54A5A62D34d3C55Cb35Bb8B4d4C958c820c5f322', operatorAddress='0x54A5A62D34d3C55Cb35Bb8B4d4C958c820c5f322', tokenId='111875105896522767201998009571114989808106447240989160672650322275489228602620', amount=1, value=0, gasLimit=147908, gasPrice=40000000000, gasUsed=115697, blockNumber=12839305, blockHash='0x7e36a9f127f3413595ef0f1c4165e4547d20ab566b66fc51a3cbe9eb048f3154', blockDate=datetime.datetime(2021, 7, 16, 18, 41, 41), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0x7d15427902a0ae5cb45b20cb38ab4ef0aab204ba1e4ae120f2b3b4d1c40cb688', registryAddress='0x395E5461693e0bB5EC78302605030050f69e628d', fromAddress='0x913C7fa57e6690f96B4AEB65553f0ED3664CAF8b', toAddress='0xA8E3582964ffA96621a767468b1D66207211df00', operatorAddress='0x913C7fa57e6690f96B4AEB65553f0ED3664CAF8b', tokenId='1861', amount=1, value=0, gasLimit=97681, gasPrice=40000000000, gasUsed=82681, blockNumber=12839305, blockHash='0x7e36a9f127f3413595ef0f1c4165e4547d20ab566b66fc51a3cbe9eb048f3154', blockDate=datetime.datetime(2021, 7, 16, 18, 41, 41), tokenType='erc721'), 
        RetrievedTokenTransfer(transactionHash='0x610b0e54f476ecada3fcc5afe330e967b0f8cc22dafa4cd1983f0f2a204bead3', registryAddress='0xd07dc4262BCDbf85190C01c996b4C06a461d2430', fromAddress='0xe46ec6498B186AaA8C2222c703c463982734D01A', toAddress='0x7AFB8fAC50362DDf276df66a8010ff032BBE1345', operatorAddress='0x4feE7B061C97C9c496b01DbcE9CDb10c02f0a0Be', tokenId='640491', amount=18, value=1826550000000000000, gasLimit=329641, gasPrice=40000000000, gasUsed=325169, blockNumber=12839305, blockHash='0x7e36a9f127f3413595ef0f1c4165e4547d20ab566b66fc51a3cbe9eb048f3154', blockDate=datetime.datetime(2021, 7, 16, 18, 41, 41), tokenType='erc1155single'),
        RetrievedTokenTransfer(transactionHash='0x9e52523fc2de27af5e927d20a5b895024c46d7e9cebe758303c9768c3f756c19', registryAddress='0x495f947276749Ce646f68AC8c248420045cb7b5e', fromAddress='0xDc62e941fDDBDdDFc666B133E24E0C1aFae11847', toAddress='0xC4e245226537A0B1c5AF30079Eb0251504b42793', operatorAddress='0x750a32FAB9AE3B4ba3c15fF3d140b19aC92f25D8', tokenId='99683587586696680377209091673774721318238762396163454333212325529815842029569', amount=1, value=50000000000000000, gasLimit=228450, gasPrice=40000000000, gasUsed=218447, blockNumber=12839305, blockHash='0x7e36a9f127f3413595ef0f1c4165e4547d20ab566b66fc51a3cbe9eb048f3154', blockDate=datetime.datetime(2021, 7, 16, 18, 41, 41), tokenType='erc1155single')
    ]
    assert (result == expected)


if __name__ == '__main__':
    logging.basicConfig(level=logging.INFO)
    asyncio.run(main())
